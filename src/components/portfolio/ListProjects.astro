---
import Project from "./Project.astro";
import { getLangFromUrl, useTranslations } from '../../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// 1. Importar todas las im√°genes de proyectos
const projectImages = import.meta.glob<{ default: ImageMetadata }>('/src/assets/images/projects/*.webp', { eager: true });

// 2. Cargar proyectos de ambos idiomas y filtrar
const projectModules = import.meta.glob('../../pages/**/portfolio/*.md', { eager: true });
let projects = Object.values(projectModules).filter((m: any) => m && m.url && m.url.startsWith(`/${lang}/`));

// 3. Mapear cada proyecto para incluir el objeto de imagen importado
const projectsWithImages = projects.map((project) => {
  const imageUrl = project.frontmatter.image?.url;
  if (!imageUrl) return { ...project, loadedImage: null };

  const imagePath = `/src/assets/images/projects/${imageUrl.split('/').pop()}`;
  const loadedImage = projectImages[imagePath]?.default;
  
  return { ...project, loadedImage };
});

// 4. Ordenar por fecha descendente
projectsWithImages.sort(
  (a, b) =>
    new Date(b.frontmatter.pubDate).getTime() -
    new Date(a.frontmatter.pubDate).getTime(),
);
---

<section class="relative pt-8 pb-32 max-2xl:px-8 max-md:pt-4">
  <div class="mx-auto max-w-7xl py-8">
    <slot />
  </div>

  <div
    id="containerProjects"
    class="mx-auto max-w-7xl grid grid-cols-3 max-lg:grid-cols-2 max-md:grid-cols-1 gap-5 p-2 py-4 max-h-[150vh] overflow-hidden transition-[max-height] duration-500 ease-in-out"
  >
    {
      projectsWithImages.map((post) => (
        <Project
          url={post.url}
          title={post.frontmatter.title}
          description={post.frontmatter.description}
          date={post.frontmatter.pubDate}
          languages={post.frontmatter.languages}
          image={post.frontmatter.image}
          loadedImage={post.loadedImage}
        />
      ))
    }
  </div>

  <div
    id="moreProjects"
    class="absolute bottom-0 left-0 w-full flex justify-center text-center bg-linear-to-t from-[#FBFEFD] dark:from-[#0e0e10] from-55% to-transparent to-100% pb-30 pt-52"
  >
    <button
      class="absolute font-bold cursor-pointer text-mint-400 dark:text-mint-100 hover:text-mint-500 dark:hover:text-mint-300 transition-all"
    >
      {t('projects.viewMore')}
    </button>
  </div>
</section>

<script>
  document.querySelector("#moreProjects")?.addEventListener("click", () => {
    const contenedor = document.querySelector("#containerProjects") as HTMLElement;
    const moreprojects = document.querySelector("#moreProjects");

    if (contenedor && moreprojects) {
      // Use a very large max height to show all content
      contenedor.style.maxHeight = "15000px";
      // Hide the view more button
      setTimeout(() => {
        moreprojects.classList.add("hidden");
      }, 5000);
    }
  });
</script>
