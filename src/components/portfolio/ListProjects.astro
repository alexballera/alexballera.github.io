---
import Project from "./Project.astro";
import { getLangFromUrl } from '../../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const allProjects = await Astro.glob("../../pages/portfolio/projects/*.md") as any[];

// Filtrar proyectos por idioma (los que no tienen sufijo de idioma son en español -idioma por defecto)
// y los que tienen el sufijo correcto para el idioma actual
const filteredProjects = allProjects.filter((project) => {
  const fileName = project.file.split('/').pop();
  // Si estamos en inglés, mostrar solo los archivos que terminan en -en.md
  if (lang === 'en') {
    return fileName.endsWith('-en.md');
  }
  // Si estamos en español, mostrar solo los archivos que NO terminan en -en.md
  return !fileName.endsWith('-en.md');
});

// Sort by descending date (most recent first)
filteredProjects.sort(
  (a, b) =>
    new Date(b.frontmatter.pubDate).getTime() -
    new Date(a.frontmatter.pubDate).getTime(),
);
---

<section class="relative pt-8 pb-32 max-2xl:px-8 max-md:pt-4">
  <div class="mx-auto max-w-7xl py-8">
    <slot />
  </div>

  <div
    id="containerProjects"
    class="mx-auto max-w-7xl grid grid-cols-3 max-lg:grid-cols-2 max-md:grid-cols-1 gap-5 p-2 py-4 max-h-[150vh] overflow-hidden transition-[max-height] duration-500 ease-in-out"
  >
    {
      filteredProjects.map((post) => (
        <Project
          url={post.url}
          title={post.frontmatter.title}
          description={post.frontmatter.description}
          date={post.frontmatter.pubDate}
          languages={post.frontmatter.languages}
          image={post.frontmatter.image}
        />
      ))
    }
  </div>

  <div
    id="moreProjects"
    class="absolute bottom-0 left-0 w-full flex justify-center text-center bg-linear-to-t from-[#FBFEFD] dark:from-[#0e0e10] from-55% to-transparent to-100% pb-30 pt-52"
  >
    <button
      class="absolute font-bold cursor-pointer text-mint-400 dark:text-mint-100 hover:text-mint-500 dark:hover:text-mint-300 transition-all"
    >
      View More Projects...
    </button>
  </div>
</section>

<script>
  document.querySelector("#moreProjects")?.addEventListener("click", () => {
    const contenedor = document.querySelector("#containerProjects") as HTMLElement;
    const moreprojects = document.querySelector("#moreProjects");

    if (contenedor && moreprojects) {
      // Use a very large max height to show all content
      contenedor.style.maxHeight = "15000px";
      // Hide the view more button
      setTimeout(() => {
        moreprojects.classList.add("hidden");
      }, 5000);
    }
  });
</script>
